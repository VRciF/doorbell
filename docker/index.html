<html>
<head>
</head>
<body>
  <script>
function checkEndian() {
    var arrayBuffer = new ArrayBuffer(2);
    var uint8Array = new Uint8Array(arrayBuffer);
    var uint16array = new Uint16Array(arrayBuffer);
    uint8Array[0] = 0xAA; // set first byte
    uint8Array[1] = 0xBB; // set second byte
    if(uint16array[0] === 0xBBAA) return 'l'; // little endian
    if(uint16array[0] === 0xAABB) return 'b'; // big endian
    else return 'm'; // mixed endian
}

var context = new (window.AudioContext || window.webkitAudioContext)();

var sampleRate = 0;
var bit  = 0;
var type = '';
var endianess = checkEndian();

var ws = null;

var recordRTC = null;
navigator.getUserMedia({video: false, audio: true}, initializeRecorder, function(e){ console.log(e); });
function initializeRecorder(stream) {
    var audioInput = context.createMediaStreamSource(stream);
    var bufferSize = 2048;
    // create a javascript node
    var recorder = context.createScriptProcessor(bufferSize, 1, 1);
    //var recorder = context.createJavaScriptNode(bufferSize, 1, 1);
    // specify the processing function
    recorder.onaudioprocess = recorderProcess;
    // connect stream to our recorder
    audioInput.connect(recorder);
    // connect our recorder to the previous destination
    recorder.connect(context.destination);
}
function recorderProcess(e) {
    buffer = e.inputBuffer;
    if(!ws){
        setBufferSettings(buffer);
        sampleRate = buffer.sampleRate;
        openWs();
    }
    else{
        var left = buffer.getChannelData(0);
        ws.send(left);
    }
}
function setBufferSettings(buffer){
    sampleRate = context.sampleRate;
    bit  = 32;
    type = 'f';
    switch (buffer.constructor){
        case Float32Array: bit = 32; type = 'f'; break;
        case Float64Array: bit = 64; type = 'f'; break;
        case Int8Array: bit = 8; type = 's'; break;
        case Uint8Array: case Uint8ClampedArray: bit = 8; type = 'u'; break;
        case Int16Array: bit = 16; type = 's'; break;
        case Uint16Array: bit = 16; type = 'u'; break;
        case Int32Array: bit = 32; type = 's'; break;
        case Uint32Array: bit = 32; type = 'u'; break;
    }
}
function openWs(){
    if(ws) ws.close();
    ws = new WebSocket("ws://"+window.location.hostname+":8080/?e="+endianess+"&s="+sampleRate+"&b="+bit+"&t="+type);
    ws.onerror = function(err){
        console.log("error", err);
        ws.close();
    };
    ws.onclose = function(){
        console.log("onclose");
        ws = null;
    };
}

  </script>
</body>
</html>
